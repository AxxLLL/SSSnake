<html>
<head>
    <meta charset="UTF-8">
    <title>SSSnake</title>'
    
    <link rel="stylesheet" href="style.css">
    <script src="jQuery.js"></script>
</head>
<body>
    <div id="main-frame"></div>
    <script>        
        //======================================
        const NOOB = "n00b";
        const EASY = "EASY";
        const MEDIUM = "MEDIUM";
        const HARD = "HARD";
        const VERY_HARD = "VERY HARD";
        //--------------------------------------
        LEVEL = []; //Values below are time in MS to refresh snake
        LEVEL[NOOB] = 1000;
        LEVEL[EASY] = 500;
        LEVEL[MEDIUM] = 250;
        LEVEL[HARD] = 100;
        LEVEL[VERY_HARD] = 75;
        var userLevel = MEDIUM;
        //--------------------------------------
        const mainFrame = $('#main-frame');
        //--------------------------------------
        const ROW_INDEX = 0;
        const COL_INDEX = 1;
        const ROWS = 10; //Max board rows
        const COLS = 8; //Max board cols
        //--------------------------------------
        var snake = [];
        var snakeTail = [];
        var snakeLength = 0;
        var snakePart = [];
        var gameTimer = null;
        var userPoints = 0;
        //--------------------------------------
        const DIR_UP = 0;
        const DIR_DOWN = 2;
        const DIR_LEFT = 3;
        const DIR_RIGHT = 4;
        var userDir = DIR_UP;
        var previousDir = userDir;
        //--------------------------------------
        const END_USER_BACK = 0;
        const END_HIT_BOX = 1;
        const END_EAT_SNAKE = 2;
        const END_WINNER = 3;
        //======================================
        //-------------- GAME START ------------
        //======================================
        $(document).ready(function() {
            drawMainMenu();
            drawLevelSelectMenu();
            drawGameBoard();

            hideAll();
            
            addMainMenuTriggers();
            addLevelMenuTriggers(); 
            addGameBoardMenuTriggers();
            
            openMainMenu();
        });
        //======================================
        //------------- GAME UTILS -------------
        //======================================
        function startGame() {
            resetAllGameData();
            hideAll();
            showGameBoard();
            
            initSnake();
            initSnakeEatPart();
            addButtonTriggers();
            refreshGameBoard();
        }
        //--------------------------------------  
        function endGame(reason) {
            resetAllGameData();
            
            switch(reason) {
                case END_HIT_BOX: showGameStatusLabel("Przegrana: Uderzenie w bandę!"); break;
                case END_EAT_SNAKE: showGameStatusLabel("Przegrana: Wąż sam się zjadł!"); break;
                case END_WINNER: showGameStatusLabel("Wygrana: Wąż zjadł wszystkie smakołyki!"); break;
            }           
            
            return true;
        }
        //--------------------------------------  
        function mainTimer() {
            if(!moveSnake()) return;
            refreshGameBoard();
            gameTimer = setTimeout("mainTimer()", LEVEL[userLevel]);
        }
        //--------------------------------------
        function moveSnake() {
            var headRow = snake[0][ROW_INDEX];
            var headCol = snake[0][COL_INDEX];
            
            snakeTail[ROW_INDEX] = snake[snakeLength - 1][ROW_INDEX];
            snakeTail[COL_INDEX] = snake[snakeLength - 1][COL_INDEX];
            previousDir = userDir; 
            
            switch(userDir) {
                case DIR_UP: headRow --; break;
                case DIR_DOWN: headRow ++; break;
                case DIR_LEFT: headCol --; break;
                case DIR_RIGHT: headCol ++; break;
            }
            
            if(checkIfSankeHitBorder(headRow, headCol)) return !endGame(END_HIT_BOX);
            
            for(var i = snakeLength - 1; i >= 1; i --) {
                snake[i][ROW_INDEX] = snake[i - 1][ROW_INDEX];
                snake[i][COL_INDEX] = snake[i - 1][COL_INDEX];
            }
            snake[0][ROW_INDEX] = headRow;
            snake[0][COL_INDEX] = headCol;
            
            if(checkIfSnakeEatPart(headRow, headCol)) {
                snakeLength ++;
                userPoints ++;
                if(!checkIfSnakeHasFields()) return !endGame(END_WINNER);
                else initSnakeEatPart() == false
            } else {
                snake[snakeLength][ROW_INDEX] = -1;
                snake[snakeLength][COL_INDEX] = -1;
            }
            
            if(checkIfSnakeEatHimself(headRow, headCol)) return !endGame(END_EAT_SNAKE);
            return true;
        }
        //-------------------------------------- 
        function checkIfSankeHitBorder(headRow, headCol) {
            return (headRow < 0 || headRow >= ROWS || headCol < 0 || headCol >= COLS);
        }
        //-------------------------------------- 
        function checkIfSnakeEatPart(headRow, headCol) {
            return (snakePart[ROW_INDEX] == headRow && snakePart[COL_INDEX] == headCol);
        }
        //-------------------------------------- 
        function checkIfSnakeEatHimself(headRow, headCol) {
            for(var i = 1; i < snakeLength; i ++) {
                if(snake[i][ROW_INDEX] == snake[0][ROW_INDEX] && snake[i][COL_INDEX] == snake[0][COL_INDEX]) return true;
            }
            return false;
        }
        //-------------------------------------- 
        function checkIfSnakeHasFields() {
            return ((snakeLength - 1) != (COLS * ROWS));
        }
        //-------------------------------------- 
        function resetAllGameData() {
            killGameTimer();
            resetSnakePosition();
            resetSnakeEatParts();
            resetUserDirValue();
            removeButtonTriggers();
            userPoints = 0;
        }
        //--------------------------------------        
        function resetSnakePosition() {
            for(var i = 0; i < ROWS*COLS; i ++) {
                snake[i] = [];
                snake[i][ROW_INDEX] = -1;
                snake[i][COL_INDEX] = -1;
            }
            snakeTail[ROW_INDEX] = -1;
            snakeTail[COL_INDEX] = -1;
            snakeLength = 0;  
        }        
        //--------------------------------------
        function resetSnakeEatParts() {
            snakePart[ROW_INDEX] = -1;
            snakePart[COL_INDEX] = -1;
        }
        //--------------------------------------
        function resetUserDirValue() {
            userDir = DIR_UP;
            previousDir = userDir;
        }
        //--------------------------------------
        function killGameTimer() {
            if(gameTimer != null) {
                clearTimeout(gameTimer);
                gameTimer = null;
            }
        }
        //--------------------------------------    
        function initSnake() {
            var headX = Math.floor(ROWS / 2);
            var headY = Math.floor(COLS / 2);
            var length = ((COLS - headY >= 3) ? 3 : (COLS - headY));
            
            for(var i = 0; i < length; i ++) {
                snake[i][ROW_INDEX] = headX + i;
                snake[i][COL_INDEX] = headY;
            }
            
            snakeLength = length;
        }
        //--------------------------------------    
        function initSnakeEatPart() {
            var availableCells = [];
            var index = 0;
            var cellTemp = [];
            
            for(var i = 0; i < ROWS; i ++) {
                for(var x = 0; x < COLS; x ++) {
                    var fieldNum = (i * COLS) + (x + 1);
                    console.log(fieldNum);
                    cellTemp[fieldNum] = true;
                }
            }
            
            for(var i = 0, row_index, col_index, fieldNum; i < snakeLength; i ++) {
                row_index = snake[i][ROW_INDEX];
                col_index = snake[i][COL_INDEX];
                fieldNum = (row_index * COLS) + (col_index + 1);
                cellTemp[fieldNum] = false;  
                //console.log("Snake at: " + fieldNum + " ("+(row_index - 1)+"|"+(col_index - 1)+")");
            }            
            
            for(var i = 0; i < cellTemp.length; i ++) {
                if(cellTemp[i] == true) {
                    availableCells[index ++] = i;
                }
            }
            
            if(index > 0) {
                var rand = availableCells[Math.floor(Math.random() * index)];
                var calcX = Math.ceil((rand) / COLS) - 1;
                var calcY = (rand - 1) - (calcX * COLS);

                snakePart[ROW_INDEX] = calcX;
                snakePart[COL_INDEX] = calcY;
                return true;
            }
            
            return false;
        }
        //-------------------------------------- 
        function removeButtonTriggers() {
            $(document).unbind('keypress');
        }
        //-------------------------------------- 
        function addButtonTriggers() {
            $(document).keypress(function (event) {
                var key = event.which;
                if(key == 32) { //Space - Pause/Start
                    if(gameTimer == null) mainTimer();
                    else {
                        killGameTimer();
                    }
                } else {
                    if(gameTimer == null) return;
                    else if(key == 97 || key == 52) {
                        if(previousDir != DIR_RIGHT) {
                            userDir = DIR_LEFT; //A or num. 4
                        }
                    }
                    else if(key == 100 || key == 54) {
                        if(previousDir != DIR_LEFT) {
                            userDir = DIR_RIGHT; //d or num. 6
                        }
                    }
                    else if(key == 119 || key == 56) {
                        if(previousDir != DIR_DOWN) {
                            userDir = DIR_UP; //w or num. 8
                        }
                    }
                    else if(key == 115 || key == 50) {
                        if(previousDir != DIR_UP) {
                            userDir = DIR_DOWN; //s or num. 2
                        }
                    } 
                }
            });
        }
        //======================================
        //-------------- MENU UTILS ------------
        //====================================== 
        function openMainMenu() {
            hideAll();
            showMainMenu();
        }
        //--------------------------------------
        function addMainMenuTriggers() {
            $('#new-game').click(function() {startGame()});               
            $('#select-level').click(function() {openLevelSelectMenu()});  
        }
        //--------------------------------------
        function openLevelSelectMenu() {
            hideAll();
            showLevelSelectMenu();
        }
        //--------------------------------------
        function addLevelMenuTriggers() {
            $('#level-n00b').click(function() {selectLevel(NOOB)});
            $('#level-easy').click(function() {selectLevel(EASY)});
            $('#level-medium').click(function() {selectLevel(MEDIUM)});
            $('#level-hard').click(function() {selectLevel(HARD)});
            $('#level-veryhard').click(function() {selectLevel(VERY_HARD)});
            $('#back-btn').click(function() {openMainMenu()});
        }      
        //--------------------------------------
        function selectLevel(level) {
            userLevel = level;
            openMainMenu();
        }
        //--------------------------------------
        function addGameBoardMenuTriggers() {
            $('#back-to-main-menu').click(function() {
                endGame(END_USER_BACK);
                openMainMenu();
            });     
        }        
        //--------------------------------------
        function addRestartGameTriggers() {
            $('#restart-game').click(function() {
                console.log("Test");
                startGame();
            });     
        }    
        //--------------------------------------
        function removeRestartGameTriggers() {
            $('#restart-game').off('click');
        }        
        //======================================
        //------------ DRAWING UTILS -----------
        //======================================    
        function hideGameBoard() {
            $('#game-board').hide();
        }
        //--------------------------------------
        function showGameBoard() {
            $('#game-board').show();
        }
        //--------------------------------------
        function hideMainMenu() {
            $('#main-menu').hide();
        }
        //--------------------------------------
        function showMainMenu() {
            $('#select-level').html('Poziom trudności: '+userLevel);
            $('#game-infos').html('Wybrany poziom: '+userLevel);
            $('#main-menu').show();
        }
        //--------------------------------------
        function hideLevelSelectMenu() {
            $('#level-menu').hide();
        }
        //--------------------------------------
        function showLevelSelectMenu() {
            $('#level-menu').show();
        }                       
        //--------------------------------------
        function showGameStatusLabel(label) {
            $('#game-status-label').html('<h5>'+label+'</h5><p id="restart-game" class="menu-option">>> Zacznij nową grę <<</p>');
            addRestartGameTriggers();
            $('#game-status-label').show();
        }
         //--------------------------------------
        function hideGameStatusLabel(label) {
            $('#game-status-label').hide();
            removeRestartGameTriggers();
        }        
        //--------------------------------------
        function hideAll() {
            hideMainMenu();
            hideLevelSelectMenu();
            hideGameBoard();
            hideGameStatusLabel();
        }
        //--------------------------------------
        function showAll() {
            showMainMenu();
            showLevelSelectMenu();
            showGameBoard();
        }
        //======================================
        //--------------- DRAWING --------------
        //======================================
        function drawMainMenu() {
            var mainFrameHTML = '<div id="main-menu">';
            mainFrameHTML += '<ul>';
            mainFrameHTML += '<li id="new-game" class="menu-option">Nowa gra</li>';
            mainFrameHTML += '<li id="select-level" class="menu-option">Poziom trudności</li>';
            mainFrameHTML += '</ul>';
            mainFrameHTML += '</div>';
            mainFrame.append(mainFrameHTML);
        }
        //--------------------------------------
        function drawLevelSelectMenu() {
            var levelSelectHTML = '<div id="level-menu">';
            levelSelectHTML += '<ul>';
            levelSelectHTML += '<li id="level-n00b" class="menu-option">'+NOOB+'</li>';
            levelSelectHTML += '<li id="level-easy" class="menu-option">'+EASY+'</li>';
            levelSelectHTML += '<li id="level-medium" class="menu-option">'+MEDIUM+'</li>';
            levelSelectHTML += '<li id="level-hard" class="menu-option">'+HARD+'</li>';
            levelSelectHTML += '<li id="level-veryhard" class="menu-option">'+VERY_HARD+'</li>';
            levelSelectHTML += '<li id="back-btn" class="menu-option"><- Wróć</li>';
            levelSelectHTML += '</ul>';
            levelSelectHTML += '</div>';  
            mainFrame.append(levelSelectHTML);
        }
        //--------------------------------------
        function drawGameBoard() {
            var boardHTML = '<div id="game-board">'; 
            boardHTML += '<div id="game-menu">';
            boardHTML += '<div id="back-to-main-menu" class="menu-option"><- Wróć do menu głównego</div>';
            boardHTML += '<div class="game-info-label">';
            boardHTML += '<p>Wciśnij spację żeby rozpocząć/zatrzymać grę</p>';
            boardHTML += '<p>Sterowanie W/S/A/D lub klawiatura numeryczna 8/2/4/6</p>';
            boardHTML += '</div>';
            boardHTML += '<div id="game-status-label"></div>';
            boardHTML += '</div>';
            boardHTML += '<div id="board">';
            for(var i = 0; i < ROWS; i ++) {
                boardHTML += '<div id="board-row-'+i+'" class="board-row">';
                for(var x = 0; x < COLS; x ++) {
                    boardHTML += '<div id="board-cell-'+i+'-'+x+'" class="board-cell empty-element"></div>';
                }
                boardHTML += '</div>';
            }           
            boardHTML += '</div>';
            boardHTML += '<div id="game-infos">Wybrany poziom:</div>';
            boardHTML += '<div id="game-points">Punkty:</div>';
            boardHTML += '</div>';
            mainFrame.append(boardHTML);
        }
        //--------------------------------------
        function refreshGameBoard() {
            $('.board-cell').removeClass('snake-element');
            $('.board-cell').removeClass('snake-part-element');
            $('#board-cell-'+snakePart[ROW_INDEX]+'-'+snakePart[COL_INDEX]+'').addClass('snake-part-element');
            for(var i = 0; i < snakeLength; i ++) {
                $('#board-cell-'+snake[i][ROW_INDEX]+'-'+snake[i][COL_INDEX]+'').addClass('snake-element');
            }   
            $('#game-points').html("Zdobyte punkty: " + userPoints);
            
        }
    </script>
</body>
</html>